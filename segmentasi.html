<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Segmentation Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
  :root {
    --bg: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    --card: #2d2d2d;
    --text: #ffffff;
    --muted: #cccccc;
    --accent: #667eea;
    --accent2: #764ba2;
    /* Cluster Colors */
    --c-loyalty: #7c3aed; /* Purple */
    --c-risk: #ef4444;    /* Red */
    --c-need_attention: #f59e0b; /* Amber */
    --c-local-base: #10b981; /* Emerald */
  }
  * { box-sizing: border-box; }
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    padding: 20px;
    transition: background 0.25s, color 0.25s;
    line-height: 1.6;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto 18px;
  }
  .title {
    font-size: 28px;
    font-weight: 700;
    text-align: center;
    width: 100%;
  }
  .sub {
    color: var(--muted);
    font-size: 13px;
    text-align: center;
    margin-top: 6px;
  }
  .intro {
    max-width: 1200px;
    margin: 0 auto 30px;
    text-align: center;
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  }
  .intro h2 {
    color: var(--accent);
    margin-bottom: 10px;
  }
  .intro p {
    font-size: 16px;
    color: var(--muted);
  }

  .top-kpis {
    display: flex;
    gap: 16px;
    max-width: 1200px;
    margin: 18px auto;
  }
  .kpi {
    flex: 1;
    background: linear-gradient(135deg, var(--card), rgba(45,45,45,0.8));
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
  }
  .kpi:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.7);
  }
  .kpi.global {
    background: linear-gradient(135deg, #4f46e5, #7c3aed); /* Lebih vibrant ungu-biru */
    color: white;
  }
  .kpi.global .label, .kpi.global .num { color: rgba(255,255,255,0.9); }
  .kpi.local {
    background: linear-gradient(135deg, #06b6d4, #10b981); /* Lebih vibrant cyan-hijau */
    color: white;
  }
  .kpi.local .label, .kpi.local .num { color: rgba(255,255,255,0.9); }
  .kpi .icon {
    font-size: 40px;
    margin-bottom: 10px;
    display: block;
    filter: grayscale(100%);
  }
  .kpi .label {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 8px;
    font-weight: 500;
  }
  .kpi .num {
    font-size: 32px;
    font-weight: 700;
    margin: 0;
  }
  .kpi .desc {
    font-size: 12px;
    margin-top: 8px;
    color: var(--muted);
  }
  .kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }
  .kpi:hover::before {
    left: 100%;
  }

  .container {
    max-width: 1200px;
    margin: 18px auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: 18px;
    padding-bottom: 40px;
  }
  .card {
    background: var(--card);
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    transition: box-shadow 0.3s;
  }
  .card:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.7); }
  .card h3 {
    text-align: center;
    margin-bottom: 12px;
    color: var(--accent);
  }
  .card .explanation {
    font-size: 14px;
    color: var(--muted);
    margin-top: 10px;
    text-align: center;
  }

  .charts-wrapper {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
  }

  /* Adapted Cluster Insight Cards */
  .cluster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    max-width: 1200px;
    margin: 30px auto;
  }

  .insight-card {
    background: var(--card);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    transition: transform 0.2s;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    flex-direction: column;
  }
  .insight-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.7); }

  .card-header {
    padding: 15px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chart-container {
  width: 100%;
  height: 340px; /* penting */
  position: relative;
}

.chart-container canvas {
  width: 100% !important;
  height: 100% !important;
}
.donut-box canvas {
  width: 100% !important;
  height: 240px !important;
}
  
  /* Global Themes */
  .theme-loyalty .card-header { background: var(--c-loyalty); }
  .theme-risk .card-header { background: var(--c-risk); }
  .theme-need_attention .card-header { background: var(--c-need_attention); }
  
  /* Local Themes (Softer) */
  .theme-local-0 .card-header { background: linear-gradient(135deg, #ef4444, #f87171); }
  .theme-local-1 .card-header { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
  .theme-local-2 .card-header { background: linear-gradient(135deg, #10b981, #34d399); }

  .card-header h3 { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  
  .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 20px; }

  .metrics-row {
    display: flex;
    justify-content: space-between;
    background: #333333;
    padding: 10px;
    border-radius: 8px;
  }
  .metric { text-align: center; flex: 1; border-right: 1px solid #555555; }
  .metric:last-child { border-right: none; }
  .metric small { display: block; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }
  .metric strong { font-size: 0.95rem; color: var(--text); }

  .summary-text { font-size: 0.9rem; color: var(--muted); font-style: italic; border-left: 3px solid #555555; padding-left: 10px; }

  .strategy-section h4 { font-size: 0.9rem; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .strategy-list { list-style: none; padding: 0; margin: 0; }
  .strategy-list li {
    font-size: 0.85rem;
    margin-bottom: 8px;
    padding-left: 24px;
    position: relative;
    color: var(--text);
  }
  .strategy-list li::before {
    content: '\f00c'; /* Check icon */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    left: 0;
    top: 2px;
    color: var(--accent);
    font-size: 0.8rem;
  }

  /* Badge Styles */
  .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
  .bg-white-trans { background: rgba(255,255,255,0.25); color: white; }

  @media (max-width: 900px) {
    .top-kpis { flex-direction: column; }
    .charts-wrapper { grid-template-columns: 1fr; }
    .cluster-container { grid-template-columns: 1fr; }
  }
#cmpCust {
  width: 100% !important;
  height: 340px !important;
}

#pie_global,
#pie_local {
  width: 100% !important;
  height: 240px !important;
}
.legend-box {
  display: flex;
  gap: 14px;
  justify-content: center;
  margin-top: 12px;
  font-size: 14px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-color {
  width: 14px;
  height: 14px;
  border-radius: 4px;
}

</style>
</head>
<body>
<header>
  <div>
    <div class="title">Pengelompokan Pelanggan Berbasis RFM dengan Algoritma K-Means untuk Strategi Marketing Terpersonalisasi di Industri Ritel</div>
    <div class="sub"><b><h1>Data tahun 2010‚Äì2011</h1></b></div>
  </div>
</header>

<div class="intro">
  <h2>üëã Selamat Datang di Dashboard Ini!</h2>
  <p>Dashboard ini membantu Anda memahami pelanggan toko online dengan cara sederhana. Kami kelompokkan pelanggan menggunakan RFM dan K-Means, sehingga diperoleh hasil 3 cluster.</p>
</div>

<div class="top-kpis">
  <div class="kpi global">
    <div class="icon">üåç</div>
    <div class="label"><h2>Total Pelanggan (Global)</h2></div>
    <div class="num" id="globalTotal">0</div>
    <div class="desc">Jumlah semua pelanggan dari berbagai negara.</div>
  </div>
  <div class="kpi local">
    <div class="icon">üè†</div>
    <div class="label"><h2>Total Pelanggan (Local - UK)</h2></div>
    <div class="num" id="localTotal">0</div>
    <div class="desc">Jumlah pelanggan khusus dari United Kingdom.</div>
  </div>
</div>

<div class="container">
  <div class="charts-wrapper">
    <div class="card">
      <h3>üìä Perbandingan Pelanggan dalam Tiap Cluster (Global vs Local)</h3>
      <canvas id="cmpCust"></canvas>
      <div class="explanation">Grafik ini membandingkan jumlah pelanggan di setiap cluster antara data global dan local. Lihat mana yang lebih banyak!</div>
    </div>
    <div class="card">
      <h3>ü•ß Banyak Pelanggan Tiap Cluster (Global)</h3>
      <canvas id="pie_global"></canvas>
      <div id="legend_global" class="legend-box"></div>
      <div class="explanation">Pie chart menunjukkan persentase pelanggan di setiap cluster pada data global. Arahkan kursor pada diagram untuk melihat detail.</div>
    </div>
    <div class="card">
      <h3>ü•ß Banyak Pelanggan Tiap Cluster (Lokal)</h3>
      <canvas id="pie_local"></canvas>
      <div id="legend_local" class="legend-box"></div>
      <div class="explanation">Pie chart menunjukkan persentase pelanggan di setiap cluster pada data lokal. Arahkan kursor pada diagram untuk melihat detail.</div>
    </div>
  </div>
</div>

<!-- Adapted Section for Global Analysis -->
<div style="text-align: center; margin: 40px 0 25px; color: var(--accent);">
  <h1>üìå Analisis Pelanggan Global</h1>
</div>

<div class="cluster-grid">
  <div class="insight-card theme-loyalty">
    <div class="card-header">
      <h3>Cluster 0</h3>
      <span class="badge bg-white-trans">Loyalty</span>
    </div>
    <div class="card-body">
      <div class="metrics-row">
        <div class="metric"><small>Recency</small><strong>32</strong></div>
        <div class="metric"><small>Frequency</small><strong>5.47</strong></div>
        <div class="metric"><small>Monetary</small><strong>1726</strong></div>
      </div>
      <div class="summary-text">
        "Aktif & Bernilai Tinggi. Baru saja belanja, sering transaksi, nilai belanja terbesar."
      </div>
      <div class="strategy-section">
        <h4>üéØ Strategi Aksi</h4>
        <ul class="strategy-list">
          <li>Jadikan VIP untuk pengalaman eksklusif.</li>
          <li>Berikan akses "Early Bird" untuk produk baru.</li>
          <li>Voucher khusus VIP.</li>
          <li>Belanja berhadiah khusus akhir tahun.</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="insight-card theme-risk">
    <div class="card-header">
      <h3>Cluster 1</h3>
      <span class="badge bg-white-trans">At Risk</span>
    </div>
    <div class="card-body">
      <div class="metrics-row">
        <div class="metric"><small>Recency</small><strong>294</strong></div>
        <div class="metric"><small>Frequency</small><strong>1.35</strong></div>
        <div class="metric"><small>Monetary</small><strong>324</strong></div>
      </div>
      <div class="summary-text">
        "Hampir Hilang. Sudah sangat lama tidak belanja dan nilai transaksi rendah."
      </div>
      <div class="strategy-section">
        <h4>üéØ Strategi Aksi</h4>
        <ul class="strategy-list">
          <li>Tunjukkan Social Proof (testimoni/video pendek).</li>
          <li>Event "Comeback" dengan batas waktu.</li>
          <li>Diskon besar (Flash Sale) untuk pemicu impulsif.</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="insight-card theme-need_attention">
    <div class="card-header">
      <h3>Cluster 2</h3>
      <span class="badge bg-white-trans">Need Attention</span>
    </div>
    <div class="card-body">
      <div class="metrics-row">
        <div class="metric"><small>Recency</small><strong>153</strong></div>
        <div class="metric"><small>Frequency</small><strong>2.21</strong></div>
        <div class="metric"><small>Monetary</small><strong>580</strong></div>
      </div>
      <div class="summary-text">
        "Kurang Aktif. Belanja jarang, namun potensi spending menengah."
      </div>
      <div class="strategy-section">
        <h4>üéØ Strategi Aksi</h4>
        <ul class="strategy-list">
          <li>Edukasi value produk (Content Marketing).</li>
          <li>Bundling produk diminati dengan kurang diminati.</li>
          <li>Voucher diskon pembelian berikutnya.</li>
          <li>Program tebus murah dengan minimum pembelian.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="section-title">
<div style="text-align: center; margin: 40px 0 25px; color: var(--accent);">
  <h1>üìå Analisis Pelanggan Lokal</h1>
</div>

  <div class="cluster-grid">
    <div class="insight-card theme-local-0">
      <div class="card-header">
        <h3><i class="fa-solid fa-user-clock"></i> Cluster 0</h3>
        <span class="badge bg-white-trans">At Risk</span>
      </div>
      <div class="card-body">
        <div class="metrics-row">
          <div class="metric"><small>Recency</small><strong>293</strong></div>
          <div class="metric"><small>Frequency</small><strong>1.36</strong></div>
          <div class="metric"><small>Monetary</small><strong>306</strong></div>
        </div>
        <p class="summary-text">"Hampir Hilang. Sudah sangat lama tidak belanja dan nilai transaksi rendah."</p>
        <div class="strategy-section">
          <h4><i class="fa-solid fa-bullseye"></i> Strategi Aksi</h4>
          <ul class="strategy-list">
            <li>Promosi Testimoni & Social Proof.</li>
            <li>Kompetisi berhadiah dengan syarat dan ketentuan (Misal minimum belanja 10 kali).</li>
            <li>Diskon tengah malam (jam 10.00 keatas ada diskon 10%).</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="insight-card theme-local-1">
      <div class="card-header">
        <h3><i class="fa-solid fa-hand-holding-dollar"></i> Cluster 1</h3>
        <span class="badge bg-white-trans">Need Attention</span>
      </div>
      <div class="card-body">
        <div class="metrics-row">
          <div class="metric"><small>Recency</small><strong>154</strong></div>
          <div class="metric"><small>Frequency</small><strong>2.23</strong></div>
          <div class="metric"><small>Monetary</small><strong>547</strong></div>
        </div>
        <p class="summary-text">Kurang Aktif. Belanja jarang, namun potensi spending menengah.</p>
        <div class="strategy-section">
          <h4><i class="fa-solid fa-bullseye"></i> Strategi Aksi</h4>
          <ul class="strategy-list">
            <li>Konten edukasi produk.</li>
            <li>Bundling produk diminati dengan jarang diminati.</li>
            <li>Insentif Voucher Next Purchase.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="insight-card theme-local-2">
      <div class="card-header">
        <h3><i class="fa-solid fa-star"></i> Cluster 2</h3>
        <span class="badge bg-white-trans">Loyalty</span>
      </div>
      <div class="card-body">
        <div class="metrics-row">
          <div class="metric"><small>Recency</small><strong>32</strong></div>
          <div class="metric"><small>Freq</small><strong>5.41</strong></div>
          <div class="metric"><small>Money</small><strong>1592</strong></div>
        </div>
        <p class="summary-text">Aktif & Bernilai Tinggi. Baru saja belanja, sering transaksi, nilai belanja terbesar.</p>
        <div class="strategy-section">
          <h4><i class="fa-solid fa-bullseye"></i> Strategi Aksi</h4>
          <ul class="strategy-list">
            <li>Program Loyalty VIP Lokal.</li>
            <li>Akses eksklusif produk baru.</li>
            <li>Hadiah apresiasi tahunan.</li>
            <li>Belanja berhadiah melalui kupon setiap akhir tahun.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
Chart.register(ChartDataLabels);

let chartCmpCust, chartPieGlobal, chartPieLocal; // <-- simpan objek grafik

<script>
Chart.register(ChartDataLabels);

let chartCmpCust, chartPieGlobal, chartPieLocal;

async function loadGlobal() {
  try {
    // Mengubah path menjadi relatif: './hasil_rfm_kmeans.csv'
    const res = await fetch("/hasil_rfm_kmeans.csv"); 
    if (!res.ok) throw new Error("Gagal memuat CSV Global. Status: " + res.status);
    return parseCSV(await res.text());
  } catch (e) {
    console.error("Kesalahan saat memuat data Global:", e.message);
    return [];
  }
}

async function loadLocal() {
  try {
    // Mengubah path menjadi relatif: './hasil_rfm_kmeans_lokal.csv'
    const res = await fetch("/hasil_rfm_kmeans_lokal.csv"); 
    if (!res.ok) throw new Error("Gagal memuat CSV Lokal. Status: " + res.status);
    return parseCSV(await res.text());
  } catch (e) {
    console.error("Kesalahan saat memuat data Lokal:", e.message);
    return [];
  }
}

function parseCSV(text) {
  // Fungsi parsing tetap sama
  return text.trim().split("\n").slice(1).map(r => {
    const c = r.split(",");
    return {
      customerID: c[0],
      recency: Number(c[1]),
      frequency: Number(c[2]),
      monetary: Number(c[3]),
      segment: c[9],
      cluster: Number(c[10])
    };
  });
}

const globalColors = ["#7c3aed", "#ef4444", "#f59e0b"];
const localColors = ["#ef4444", "#f59e0b", "#10b981"];

Promise.all([loadGlobal(), loadLocal()]).then(([global, local]) => {

  // Pastikan data berhasil dimuat sebelum mencoba menghitung total
  if (global.length === 0 && local.length === 0) {
    console.warn("Semua data gagal dimuat atau kosong. Chart tidak digambar.");
    document.getElementById("globalTotal").textContent = "Error";
    document.getElementById("localTotal").textContent = "Error";
    return;
  }

  document.getElementById("globalTotal").textContent = global.length.toLocaleString();
  document.getElementById("localTotal").textContent = local.length.toLocaleString();

  const g = {0: 0, 1: 0, 2: 0};
  const l = {0: 0, 1: 0, 2: 0};
  global.forEach(x => { if (g[x.cluster] !== undefined) g[x.cluster]++; });
  local.forEach(x => { if (l[x.cluster] !== undefined) l[x.cluster]++; });

  const labelColor = getComputedStyle(document.body).color;

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: "bottom", labels: { usePointStyle: true, color: labelColor, padding: 20 }},
      datalabels: { color: "#fff", font: { weight: "bold" } }
    }
  };

  // ======= BAR PERBANDINGAN GLOBAL VS LOKAL =======
  if (chartCmpCust) chartCmpCust.destroy();
  chartCmpCust = new Chart(document.getElementById("cmpCust"), {
    type: "bar",
    data: {
      labels: ["Loyalti", "At Risk", "Need Attention"],
      datasets: [
        // Pastikan mapping klaster sudah benar: Global (0=Loyalty, 1=At Risk, 2=Need Attention)
        { label: "Global", data: [g[0], g[1], g[2]], backgroundColor: "#6366f1", borderRadius: 6 }, 
        // Pastikan mapping klaster sudah benar: Lokal (2=Loyalty, 0=At Risk, 1=Need Attention)
        { label: "Lokal", data: [l[2], l[0], l[1]], backgroundColor: "#10b981", borderRadius: 6 } 
      ]
    },
    options: {
      ...commonOptions,
      plugins: { legend: { position: "top", labels: { color: labelColor }}, datalabels: { display: false }},
      scales: {
        y: { beginAtZero: true, ticks: { color: labelColor }},
        x: { ticks: { color: labelColor }}
      }
    }
  });

  // ======= PIE GLOBAL =======
  if (chartPieGlobal) chartPieGlobal.destroy();
  chartPieGlobal = new Chart(document.getElementById("pie_global"), {
    type: "pie",
    data: {
      labels: ["Loyalty (0)", "At Risk (1)", "Need Attention (2)"],
      datasets: [{
        data: [g[0], g[1], g[2]],
        backgroundColor: globalColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.label;
              const value = ctx.raw;
              const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const percent = ((value / sum) * 100).toFixed(1);
              return `${label} ‚Äî ${value} pelanggan, ${percent}%`;
            }
          }
        }
      }
    }
  });

  // ======= PIE LOKAL =======
  if (chartPieLocal) chartPieLocal.destroy();
  chartPieLocal = new Chart(document.getElementById("pie_local"), {
    type: "pie",
    data: {
      labels: ["At Risk (0)", "Need Attention (1)", "Loyalty (2)"],
      datasets: [{
        data: [l[0], l[1], l[2]],
        backgroundColor: localColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.label;
              const value = ctx.raw;
              const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const percent = ((value / sum) * 100).toFixed(1);
              return `${label} ‚Äî ${value} pelanggan, ${percent}%`;
            }
          }
        }
      }
    }
  });
  
  // Perbarui Legenda
  document.getElementById("legend_global").innerHTML = `
    <div class="legend-item"><span class="legend-color" style="background:${globalColors[0]}"></span> Loyalty (Cluster 0)</div>
    <div class="legend-item"><span class="legend-color" style="background:${globalColors[1]}"></span> At Risk (Cluster 1)</div>
    <div class="legend-item"><span class="legend-color" style="background:${globalColors[2]}"></span> Need Attention (Cluster 2)</div>
  `;

  document.getElementById("legend_local").innerHTML = `
    <div class="legend-item"><span class="legend-color" style="background:${localColors[0]}"></span> At Risk (Cluster 0)</div>
    <div class="legend-item"><span class="legend-color" style="background:${localColors[1]}"></span> Need Attention (Cluster 1)</div>
    <div class="legend-item"><span class="legend-color" style="background:${localColors[2]}"></span> Loyalty (Cluster 2)</div>
  `;
})
</script>

const globalColors = ["#7c3aed", "#ef4444", "#f59e0b"];
const localColors = ["#ef4444", "#f59e0b", "#10b981"];

Promise.all([loadGlobal(), loadLocal()]).then(([global, local]) => {

  document.getElementById("globalTotal").textContent = global.length.toLocaleString();
  document.getElementById("localTotal").textContent = local.length.toLocaleString();

  const g = {0: 0, 1: 0, 2: 0};
  const l = {0: 0, 1: 0, 2: 0};
  global.forEach(x => { if (g[x.cluster] !== undefined) g[x.cluster]++; });
  local.forEach(x => { if (l[x.cluster] !== undefined) l[x.cluster]++; });

  const labelColor = getComputedStyle(document.body).color;

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: "bottom", labels: { usePointStyle: true, color: labelColor, padding: 20 }},
      datalabels: { color: "#fff", font: { weight: "bold" } }
    }
  };

  // ======= BAR PERBANDINGAN GLOBAL VS LOKAL =======
  if (chartCmpCust) chartCmpCust.destroy();
  chartCmpCust = new Chart(document.getElementById("cmpCust"), {
    type: "bar",
    data: {
      labels: ["Loyalti", "At Risk", "Need Attention"],
      datasets: [
        { label: "Global", data: [g[0], g[1], g[2]], backgroundColor: "#6366f1", borderRadius: 6 },
        { label: "Lokal", data: [l[2], l[0], l[1]], backgroundColor: "#10b981", borderRadius: 6 }
      ]
    },
    options: {
      ...commonOptions,
      plugins: { legend: { position: "top", labels: { color: labelColor }}, datalabels: { display: false }},
      scales: {
        y: { beginAtZero: true, ticks: { color: labelColor }},
        x: { ticks: { color: labelColor }}
      }
    }
  });

  // ======= PIE GLOBAL =======
if (chartPieGlobal) chartPieGlobal.destroy();
chartPieGlobal = new Chart(document.getElementById("pie_global"), {
  type: "pie", // tidak ada lubang tengah
  data: {
    labels: ["Loyalty (0)", "At Risk (1)", "Need Attention (2)"],
    datasets: [{
      data: [g[0], g[1], g[2]],
      backgroundColor: globalColors,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },        // tidak ada tulisan bawah
      datalabels: { display: false },    // tidak ada angka dalam chart
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const label = ctx.label;
            const value = ctx.raw;
            const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const percent = ((value / sum) * 100).toFixed(1);
            return `${label} ‚Äî ${value} pelanggan, ${percent}%`;
          }
        }
      }
    }
  }
});

// ======= PIE LOKAL =======
if (chartPieLocal) chartPieLocal.destroy();
chartPieLocal = new Chart(document.getElementById("pie_local"), {
  type: "pie", // tidak ada lubang tengah
  data: {
    labels: ["At Risk (0)", "Need Attention (1)", "Loyalty (2)"],
    datasets: [{
      data: [l[0], l[1], l[2]],
      backgroundColor: localColors,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      datalabels: { display: false },
      tooltip: {
        callbacks: {
          label: function(ctx) {
            const label = ctx.label;
            const value = ctx.raw;
            const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const percent = ((value / sum) * 100).toFixed(1);
            return `${label} ‚Äî ${value} pelanggan, ${percent}%`;
          }
        }
      }
    }
  }
});
document.getElementById("legend_global").innerHTML = `
  <div class="legend-item"><span class="legend-color" style="background:${globalColors[0]}"></span> Loyalty (Cluster 0)</div>
  <div class="legend-item"><span class="legend-color" style="background:${globalColors[1]}"></span> At Risk (Cluster 1)</div>
  <div class="legend-item"><span class="legend-color" style="background:${globalColors[2]}"></span> Need Attention (Cluster 2)</div>
`;

document.getElementById("legend_local").innerHTML = `
  <div class="legend-item"><span class="legend-color" style="background:${localColors[0]}"></span> At Risk (Cluster 0)</div>
  <div class="legend-item"><span class="legend-color" style="background:${localColors[1]}"></span> Need Attention (Cluster 1)</div>
  <div class="legend-item"><span class="legend-color" style="background:${localColors[2]}"></span> Loyalty (Cluster 2)</div>
`;


})
</script>

</body>
</html>





